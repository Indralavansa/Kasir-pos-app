{% extends 'base.html' %}

{% block page_title %}Kasir{% endblock %}

{% block extra_css %}
<style>
    .product-card {
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        border-color: #4361ee;
    }
    
    .cart-item {
        padding: 10px 0;
        border-bottom: 1px solid #eee;
    }
    
    .cart-total {
        font-size: 1.5rem;
        font-weight: bold;
        color: #4361ee;
    }
    
    .cart-change {
        font-size: 1.5rem;
        font-weight: bold;
    }
    
    .payment-methods {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 12px;
        background-color: #f8f9fa;
    }
    
    .payment-methods .form-check {
        margin-bottom: 8px;
    }
    
    .payment-methods .form-check:last-child {
        margin-bottom: 0;
    }
    
    .payment-methods .form-check-input {
        border-color: #4361ee;
    }
    
    .payment-methods .form-check-input:checked {
        background-color: #4361ee;
        border-color: #4361ee;
    }
    
    .payment-methods .form-check-label {
        margin-left: 5px;
        cursor: pointer;
        font-weight: 500;
    }
    
    .member-verified {
        border-color: #28a745 !important;
        border-width: 2px !important;
    }
    
    .member-unverified {
        border-color: #dc3545 !important;
        border-width: 2px !important;
    }
    
    .member-neutral {
        border-color: #ced4da;
    }
    
    .member-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        max-height: 250px;
        overflow-y: auto;
        z-index: 1000;
        margin-top: 4px;
        display: none;
    }
    
    .member-suggestions.show {
        display: block;
    }
    
    .member-suggestion-item {
        padding: 12px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .member-suggestion-item:last-child {
        border-bottom: none;
    }
    
    .member-suggestion-item:hover {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .member-suggestion-item:hover .member-icon {
        background: white;
        color: #667eea;
    }
    
    .member-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 16px;
        flex-shrink: 0;
        transition: all 0.2s;
    }
    
    .member-info {
        flex: 1;
    }
    
    .member-name {
        font-weight: 600;
        margin-bottom: 2px;
        font-size: 14px;
    }
    
    .member-phone {
        font-size: 12px;
        color: #6c757d;
    }
    
    .member-suggestion-item:hover .member-phone {
        color: rgba(255,255,255,0.9);
    }
    
    .no-results {
        padding: 20px;
        text-align: center;
        color: #6c757d;
        font-style: italic;
    }
    
    .products-container {
        max-height: calc(4 * 200px); /* 4 baris x tinggi card ~200px */
        overflow-y: auto;
        overflow-x: hidden;
        padding-right: 5px;
    }
    
    .products-container::-webkit-scrollbar {
        width: 8px;
    }
    
    .products-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    
    .products-container::-webkit-scrollbar-thumb {
        background: #4361ee;
        border-radius: 10px;
    }
    
    .products-container::-webkit-scrollbar-thumb:hover {
        background: #3451ce;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-shopping-basket me-2"></i>Daftar Produk</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" id="productSearch" class="form-control" placeholder="Cari nama atau barcode">
                        </div>
                        <small class="text-muted">Ketik nama barang atau barcode</small>
                    </div>
                </div>
                <div class="products-container">
                    <div class="row">
                        {% for produk in produk_list %}
                        <div class="col-md-4 mb-3">
                        {% set variants_json = [] %}
                        {% if produk.harga_variasi %}
                            {% for v in produk.harga_variasi %}
                                {% set _ = variants_json.append({'min_qty': v.min_qty, 'harga': v.harga, 'keterangan': v.keterangan}) %}
                            {% endfor %}
                        {% endif %}
                        <div class="product-card" 
                             data-id="{{ produk.id }}" 
                             data-name="{{ produk.nama }}" 
                                data-code="{{ produk.kode }}"
                             data-price="{{ produk.harga_jual }}"
                             data-variants='{{ variants_json | tojson }}'>
                            <h6 class="mb-1">{{ produk.nama }}</h6>
                            <p class="text-muted small mb-1">{{ produk.kode }}</p>
                            <h5 class="text-primary mb-1">Rp {{ "{:,.0f}".format(produk.harga_jual) }}</h5>
                            {% if produk.harga_variasi %}
                            <div class="text-success small mb-1">
                                <i class="fas fa-tags"></i> Harga Variasi:
                                {% for variant in produk.harga_variasi %}
                                <div class="ms-2">{{ variant.min_qty }}+ pcs = Rp {{ "{:,.0f}".format(variant.harga) }}
                                {% if variant.keterangan %}<span class="badge bg-success">{{ variant.keterangan }}</span>{% endif %}</div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            <span class="badge bg-{% if produk.stok > 0 %}success{% else %}danger{% endif %}">
                                Stok: {{ produk.stok }}
                            </span>
                        </div>
                        </div>
                    {% endfor %}
                    </div>
                </div>
                <div class="text-center text-muted mt-3 d-none" id="noProductResults">
                    Tidak ada produk yang cocok.
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Keranjang Belanja</h5>
            </div>
            <div class="card-body">
                <div id="cartItems">
                    <div class="text-center py-4">
                        <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Keranjang kosong</p>
                        <small>Klik produk untuk menambahkan</small>
                    </div>
                </div>
                
                <div class="mt-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Total:</span>
                        <span class="cart-total" id="cartTotal">Rp 0</span>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Bayar</label>
                        <input type="number" id="payment" class="form-control" placeholder="Jumlah bayar" min="0">
                    </div>
                    
                    <div class="d-flex justify-content-between mb-3">
                        <span>Kembalian:</span>
                        <span class="cart-change text-success" id="change">Rp 0</span>
                    </div>

                    <div class="mb-3" style="position: relative;">
                        <label class="form-label">Member</label>
                        <input type="text" id="memberInput" class="form-control member-neutral" placeholder="Ketik nama atau nomor telepon" autocomplete="off">
                        <input type="hidden" id="memberIdHidden">
                        <div id="memberSuggestions" class="member-suggestions"></div>
                        <small class="text-muted" id="memberStatus">Pilih dari daftar atau ketik manual</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Metode Pembayaran</label>
                        <div class="payment-methods">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="methTunai" value="tunai" checked>
                                <label class="form-check-label" for="methTunai">
                                    <i class="fas fa-money-bill me-1"></i>Tunai
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="methQRIS" value="qris">
                                <label class="form-check-label" for="methQRIS">
                                    <i class="fas fa-qrcode me-1"></i>QRIS
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="methEWallet" value="ewallet">
                                <label class="form-check-label" for="methEWallet">
                                    <i class="fas fa-credit-card me-1"></i>E-Wallet
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="methDebit" value="debit">
                                <label class="form-check-label" for="methDebit">
                                    <i class="fas fa-credit-card me-1"></i>Debit
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="methHutang" value="hutang">
                                <label class="form-check-label" for="methHutang">
                                    <i class="fas fa-handshake me-1"></i>Hutang
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-success btn-lg" id="btnCheckout" disabled>
                            <i class="fas fa-cash-register me-2"></i>Checkout
                        </button>
                        <button class="btn btn-outline-danger" id="btnClearCart">
                            <i class="fas fa-trash me-2"></i>Kosongkan
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let cart = [];
    let cartTotal = 0;
    
    function formatRupiah(angka) {
        return 'Rp ' + angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }
    
    function addToCart(id, name, priceNormal, priceVariants) {
        // Cek apakah produk sudah ada di keranjang
        const existingItem = cart.find(item => item.id === id);
        
        if (existingItem) {
            existingItem.quantity++;
        } else {
            cart.push({
                id: id,
                name: name,
                priceNormal: priceNormal,
                priceVariants: priceVariants,  // Array of {min_qty, harga}
                quantity: 1,
                currentPrice: priceNormal,
                total: priceNormal
            });
        }
        
        // Recalculate price based on quantity
        recalculateItemPrice(existingItem || cart[cart.length - 1]);
        updateCart();
    }
    
    function recalculateItemPrice(item) {
        // Cek di price variants jika ada
        if (item.priceVariants && item.priceVariants.length > 0) {
            // Sort descending by min_qty untuk cek dari qty terbesar
            const sortedVariants = [...item.priceVariants].sort((a, b) => b.min_qty - a.min_qty);
            
            // Cari harga yang sesuai dengan quantity
            let foundPrice = null;
            for (const variant of sortedVariants) {
                if (item.quantity >= variant.min_qty) {
                    foundPrice = variant.harga;
                    break;
                }
            }
            
            item.currentPrice = foundPrice || item.priceNormal;
        } else {
            item.currentPrice = item.priceNormal;
        }
        
        item.total = item.quantity * item.currentPrice;
    }
    
    function updateCart() {
        // Hitung total
        cartTotal = cart.reduce(function(sum, item) {
            return sum + item.total;
        }, 0);
        
        // Update display total
        document.getElementById('cartTotal').textContent = formatRupiah(cartTotal);
        
        // Update cart items display
        const cartItemsDiv = document.getElementById('cartItems');
        
        if (cart.length === 0) {
            cartItemsDiv.innerHTML = '<div class="text-center py-4"><i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i><p class="text-muted">Keranjang kosong</p><small>Klik produk untuk menambahkan</small></div>';
        } else {
            let html = '';
            cart.forEach(function(item, index) {
                // Cari tier yang sedang aktif
                let priceLabel = formatRupiah(item.currentPrice);
                let tierInfo = '';
                
                if (item.priceVariants && item.priceVariants.length > 0) {
                    const activeVariant = item.priceVariants
                        .sort((a, b) => b.min_qty - a.min_qty)
                        .find(v => item.quantity >= v.min_qty);
                    
                    if (activeVariant) {
                        tierInfo = activeVariant.keterangan || `Tier ${activeVariant.min_qty}+`;
                        priceLabel = '<span class="badge bg-success">' + formatRupiah(item.currentPrice) + ' (' + tierInfo + ')</span>';
                    }
                }
                
                html += '<div class="cart-item"><div class="d-flex justify-content-between align-items-center"><div><h6 class="mb-1">' + item.name + '</h6><p class="text-muted small mb-0">' + priceLabel + '</p></div><div class="text-end"><div class="input-group input-group-sm mb-2" style="width: 120px;"><button class="btn btn-outline-secondary qty-decrease" data-index="' + index + '"><i class="fas fa-minus"></i></button><input type="text" class="form-control text-center" value="' + item.quantity + '" readonly><button class="btn btn-outline-secondary qty-increase" data-index="' + index + '"><i class="fas fa-plus"></i></button></div><h6 class="mb-1">' + formatRupiah(item.total) + '</h6><button class="btn btn-sm btn-outline-danger remove-item" data-index="' + index + '"><i class="fas fa-trash"></i></button></div></div></div>';
            });
            cartItemsDiv.innerHTML = html;
        }
        
        // Update checkout button
        document.getElementById('btnCheckout').disabled = cart.length === 0;
        updateChange();
    }
    
    function removeFromCart(index) {
        cart.splice(index, 1);
        updateCart();
    }
    
    function increaseQty(index) {
        cart[index].quantity++;
        recalculateItemPrice(cart[index]);
        updateCart();
    }
    
    function decreaseQty(index) {
        if (cart[index].quantity > 1) {
            cart[index].quantity--;
            recalculateItemPrice(cart[index]);
        } else {
            removeFromCart(index);
        }
        updateCart();
    }
    
    function clearCart() {
        if (cart.length > 0 && confirm('Kosongkan keranjang?')) {
            cart = [];
            updateCart();
            document.getElementById('payment').value = '';
            
            // Clear member fields
            const memberInput = document.getElementById('memberInput');
            const memberIdHidden = document.getElementById('memberIdHidden');
            const memberStatus = document.getElementById('memberStatus');
            
            if (memberInput) {
                memberInput.value = '';
                memberInput.classList.remove('member-verified', 'member-unverified');
                memberInput.classList.add('member-neutral');
            }
            if (memberIdHidden) {
                memberIdHidden.value = '';
            }
            if (memberStatus) {
                memberStatus.textContent = 'Pilih dari daftar atau ketik manual';
                memberStatus.className = 'text-muted';
            }
            
            updateChange();
        }
    }
    
    function updateChange() {
        const paymentInput = document.getElementById('payment');
        const payment = parseFloat(paymentInput.value) || 0;
        const change = payment - cartTotal;
        
        const changeElement = document.getElementById('change');
        if (change >= 0) {
            changeElement.textContent = formatRupiah(change);
            changeElement.className = 'cart-change text-success';
        } else {
            changeElement.textContent = formatRupiah(Math.abs(change)) + ' kurang';
            changeElement.className = 'cart-change text-danger';
        }
    }
    
    function checkout() {
        const paymentInput = document.getElementById('payment');
        const payment = parseFloat(paymentInput.value) || 0;
        const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
        const memberIdHidden = document.getElementById('memberIdHidden');
        const memberInput = document.getElementById('memberInput');
        const memberId = memberIdHidden.value ? parseInt(memberIdHidden.value) : null;
        const memberManual = !memberId && memberInput.value.trim() ? memberInput.value.trim() : null;
        
        if (payment < cartTotal) {
            alert('Jumlah pembayaran kurang!');
            return;
        }
        
        // Format data untuk backend (backend expects: id, quantity, price)
        const itemsForBackend = cart.map(item => ({
            id: item.id,
            quantity: item.quantity,
            price: item.currentPrice  // Harga yang sedang dipakai (bisa jual atau grosir)
        }));
        
        // Kirim data ke server
        fetch('/transaksi/checkout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                items: itemsForBackend,
                total: cartTotal,
                bayar: payment,
                payment_method: paymentMethod,
                member_id: memberId,
                member_manual: memberManual
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Redirect ke halaman struk
                window.location.href = '/transaksi/struk/' + data.transaksi_id;
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Terjadi kesalahan: ' + error.message);
        });
    }
    
    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Filter produk berdasarkan nama/barcode
        const searchInput = document.getElementById('productSearch');
        const productCards = document.querySelectorAll('.product-card');
        const noResults = document.getElementById('noProductResults');

        function filterProducts() {
            const query = (searchInput.value || '').trim().toLowerCase();
            let visibleCount = 0;

            productCards.forEach(function(card) {
                const name = (card.getAttribute('data-name') || '').toLowerCase();
                const code = (card.getAttribute('data-code') || '').toLowerCase();
                const match = !query || name.includes(query) || code.includes(query);

                card.closest('.col-md-4').style.display = match ? '' : 'none';
                if (match) {
                    visibleCount += 1;
                }
            });

            if (noResults) {
                noResults.classList.toggle('d-none', visibleCount > 0);
            }
        }

        function addByBarcode(query) {
            const normalized = (query || '').trim().toLowerCase();
            if (!normalized) {
                return false;
            }

            let matchedCard = null;
            productCards.forEach(function(card) {
                if (matchedCard) {
                    return;
                }
                const code = (card.getAttribute('data-code') || '').toLowerCase();
                if (code && code === normalized) {
                    matchedCard = card;
                }
            });

            if (!matchedCard) {
                return false;
            }

            const id = parseInt(matchedCard.getAttribute('data-id'));
            const name = matchedCard.getAttribute('data-name');
            const priceNormal = parseFloat(matchedCard.getAttribute('data-price'));
            const variantsJson = matchedCard.getAttribute('data-variants');
            const priceVariants = variantsJson ? JSON.parse(variantsJson) : [];
            addToCart(id, name, priceNormal, priceVariants);
            return true;
        }

        if (searchInput) {
            searchInput.addEventListener('input', filterProducts);
            searchInput.addEventListener('keydown', function(e) {
                if (e.key !== 'Enter') {
                    return;
                }

                const query = searchInput.value || '';
                const added = addByBarcode(query);

                if (added) {
                    searchInput.value = '';
                    filterProducts();
                }
            });
        }

        // Klik produk untuk tambah ke keranjang
        document.querySelectorAll('.product-card').forEach(function(card) {
            card.addEventListener('click', function() {
                const id = parseInt(this.getAttribute('data-id'));
                const name = this.getAttribute('data-name');
                const priceNormal = parseFloat(this.getAttribute('data-price'));
                const variantsJson = this.getAttribute('data-variants');
                const priceVariants = variantsJson ? JSON.parse(variantsJson) : [];
                addToCart(id, name, priceNormal, priceVariants);
            });
        });
        
        // Remove item dari keranjang (delegasi event)
        document.addEventListener('click', function(e) {
            if (e.target.closest('.remove-item')) {
                const index = parseInt(e.target.closest('.remove-item').getAttribute('data-index'));
                removeFromCart(index);
            }
            if (e.target.closest('.qty-increase')) {
                const index = parseInt(e.target.closest('.qty-increase').getAttribute('data-index'));
                increaseQty(index);
            }
            if (e.target.closest('.qty-decrease')) {
                const index = parseInt(e.target.closest('.qty-decrease').getAttribute('data-index'));
                decreaseQty(index);
            }
        });
        
        // Clear cart button
        document.getElementById('btnClearCart').addEventListener('click', clearCart);
        
        // Checkout button
        document.getElementById('btnCheckout').addEventListener('click', checkout);
        
        // Input bayar
        document.getElementById('payment').addEventListener('input', updateChange);
        
        // Member autocomplete
        const memberInput = document.getElementById('memberInput');
        const memberIdHidden = document.getElementById('memberIdHidden');
        const memberSuggestions = document.getElementById('memberSuggestions');
        const memberStatus = document.getElementById('memberStatus');
        
        // Data member dari server
        const memberData = [
            {% for member in member_list %}
            {
                id: {{ member.id }},
                nama: "{{ member.nama }}",
                phone: "{{ member.no_telp or '' }}"
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];
        
        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        }
        
        function showMemberSuggestions(filtered) {
            if (filtered.length === 0) {
                memberSuggestions.innerHTML = '<div class="no-results"><i class="fas fa-users-slash"></i> Tidak ada member yang cocok</div>';
                memberSuggestions.classList.add('show');
                return;
            }
            
            let html = '';
            filtered.forEach(member => {
                const initials = getInitials(member.nama);
                const displayPhone = member.phone || 'Tidak ada nomor';
                html += `
                    <div class="member-suggestion-item" data-id="${member.id}" data-name="${member.nama}" data-phone="${member.phone}">
                        <div class="member-icon">${initials}</div>
                        <div class="member-info">
                            <div class="member-name">${member.nama}</div>
                            <div class="member-phone"><i class="fas fa-phone-alt"></i> ${displayPhone}</div>
                        </div>
                    </div>
                `;
            });
            
            memberSuggestions.innerHTML = html;
            memberSuggestions.classList.add('show');
            
            // Add click handlers with mousedown (fires before blur)
            memberSuggestions.querySelectorAll('.member-suggestion-item').forEach(item => {
                item.addEventListener('mousedown', function(e) {
                    e.preventDefault(); // Prevent blur
                    const id = this.getAttribute('data-id');
                    const name = this.getAttribute('data-name');
                    const phone = this.getAttribute('data-phone');
                    
                    memberInput.value = name + (phone ? ' - ' + phone : '');
                    memberIdHidden.value = id;
                    memberSuggestions.classList.remove('show');
                    updateMemberBorder();
                    memberInput.blur(); // Remove focus after selection
                });
            });
        }
        
        function filterMembers(query) {
            if (!query) return [];
            
            const lowerQuery = query.toLowerCase();
            
            // Cek jika input adalah 4 digit
            if (/^\d{4}$/.test(query)) {
                const matchedByDigits = memberData.filter(m => m.phone && m.phone.slice(-4) === query);
                if (matchedByDigits.length === 1) {
                    // Auto-select jika hanya 1 hasil
                    const member = matchedByDigits[0];
                    memberInput.value = member.nama + (member.phone ? ' - ' + member.phone : '');
                    memberIdHidden.value = member.id;
                    updateMemberBorder();
                    return [];
                }
                return matchedByDigits;
            }
            
            // Filter berdasarkan nama atau nomor telepon
            return memberData.filter(m => {
                const matchName = m.nama.toLowerCase().includes(lowerQuery);
                const matchPhone = m.phone && m.phone.includes(lowerQuery);
                return matchName || matchPhone;
            });
        }
        
        function updateMemberBorder() {
            const inputValue = memberInput.value.trim();
            const memberId = memberIdHidden.value;
            
            // Hapus semua class border
            memberInput.classList.remove('member-verified', 'member-unverified', 'member-neutral');
            
            if (!inputValue) {
                // Kosong = neutral
                memberInput.classList.add('member-neutral');
                memberStatus.textContent = 'Pilih dari daftar atau ketik manual';
                memberStatus.className = 'text-muted';
            } else if (memberId) {
                // Ada member ID = terverifikasi (hijau)
                memberInput.classList.add('member-verified');
                memberStatus.textContent = '✓ Member terverifikasi';
                memberStatus.className = 'text-success';
            } else {
                // Ada input tapi tidak ada member ID = manual/tidak terverifikasi (merah)
                memberInput.classList.add('member-unverified');
                memberStatus.textContent = '✗ Input manual (tidak dapat poin)';
                memberStatus.className = 'text-danger';
            }
        }
        
        if (memberInput) {
            memberInput.addEventListener('input', function() {
                const inputValue = this.value.trim();
                memberIdHidden.value = '';
                
                const filtered = filterMembers(inputValue);
                
                if (inputValue && filtered.length > 0) {
                    showMemberSuggestions(filtered);
                } else if (inputValue) {
                    memberSuggestions.classList.remove('show');
                } else {
                    memberSuggestions.classList.remove('show');
                }
                
                // Update border setelah check
                updateMemberBorder();
            });
            
            // Clear saat focus
            memberInput.addEventListener('focus', function() {
                if (this.value === '' || this.value === 'Umum') {
                    this.value = '';
                    memberIdHidden.value = '';
                    updateMemberBorder();
                } else if (this.value.trim()) {
                    const filtered = filterMembers(this.value.trim());
                    if (filtered.length > 0) {
                        showMemberSuggestions(filtered);
                    }
                }
            });
            
            // Update border saat blur
            memberInput.addEventListener('blur', function() {
                // Delay untuk memberi waktu klik suggestion
                setTimeout(() => {
                    memberSuggestions.classList.remove('show');
                    updateMemberBorder();
                }, 150);
            });
        }
        
        // Update change saat halaman load
        updateChange();
    });
</script>
{% endblock %}
